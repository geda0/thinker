<!DOCTYPE html>
<html>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<h2>Post data</h2>

<form id="postForm" action="{{ url_for('index') }}" method="post" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    {{ form.data.label }} {{ form.data(rows=5, cols=40) }}
    {{ form.file.label }} {{ form.file() }}
    {{ form.submit() }}
</form>

<h2>Postings</h2>

<div id="postings">
  <!-- Postings will be inserted here by JavaScript -->
</div>

<script>
function downloadFile(url) {
  window.location.href = url;
}

setInterval(function() {
  fetch('/get_postings')
  .then(response => response.json())
  .then(data => {
    const postingsDiv = document.getElementById('postings');
    postingsDiv.innerHTML = '';
    data.reverse().forEach((posting, index) => {
      const copyButton = document.createElement('button');
      copyButton.textContent = '= = =';
      if (posting.startsWith('/uploads/')) {
        copyButton.onclick = function() { downloadFile(posting); };
      } else {
        copyButton.onclick = function() { navigator.clipboard.writeText(posting); };
      }
      if (index === 0) {
        copyButton.style.fontSize = '900%';
      }
      postingsDiv.appendChild(copyButton);

      if (!posting.startsWith('/uploads/')) {
        const pre = document.createElement('pre');
        pre.textContent = posting;
        postingsDiv.appendChild(pre);
      }

      const deleteForm = document.createElement('form');
      deleteForm.action = '/delete/' + (data.length - 1 - index);  // adjust index because we reversed the data
      deleteForm.method = 'POST';
      deleteForm.style.display = 'inline';
      const deleteButton = document.createElement('input');
      deleteButton.type = 'submit';
      deleteButton.value = '" - "';
      deleteForm.appendChild(deleteButton);
      postingsDiv.appendChild(deleteForm);

      postingsDiv.appendChild(document.createElement('br'));
    });
  });
}, 999);
</script>

</body>
</html>
